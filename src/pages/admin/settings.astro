---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

const session = Astro.cookies.get("admin_session");
if (!session || session.value !== "verified") {
  return Astro.redirect('/login');
}

let saveStatus = "";
let isPost = Astro.request.method === "POST";

if (isPost) {
  try {
    const formData = await Astro.request.formData();
    const titles = formData.getAll('about_titles[]');
    const contents = formData.getAll('about_contents[]');
    const langs = formData.getAll('about_langs[]'); 
    
    const newRows = titles
      .map((title, index) => ({
        title: title.toString().trim(),
        content: contents[index].toString().trim(),
        lang: langs[index].toString(), 
        sort_order: index 
      }))
      .filter(row => row.title !== "" && row.content !== "");

    if (newRows.length > 0) {
      await supabase.from('about_us').delete().neq('title', 'SYSTEM_RESERVED_PROTECT');
      const { error } = await supabase.from('about_us').insert(newRows);
      if (error) throw error;
      saveStatus = "SUCCESS : BASE DE DONNÉES SYNCHRONISÉE";
    } else {
      saveStatus = "DONNÉES VIDES : ANNULÉ";
    }
  } catch (err) {
    saveStatus = "ERREUR SYSTÈME : ÉCHEC DE SYNC";
  }
}

const { data: aboutSections } = await supabase
  .from('about_us')
  .select('*')
  .order('sort_order', { ascending: true });
---

<Layout title="SETTINGS | SRFL COMMAND">
  <div class="settings-wrapper">
    <header class="header-nav">
      <div class="mode-indicator">
        <span class="dot"></span> SYSTÈME EN LIGNE
      </div>
      <a href="/admin/dashboard" class="back-btn">RETOUR AU TERMINAL</a>
    </header>

    <form method="POST" class="settings-form" id="main-form" novalidate>
      <section class="config-block">
        <div class="block-header">
          <h2 class="block-title">01 // À PROPOS</h2>
          <button type="button" id="add-section" class="add-btn">+ AJOUTER UNE SECTION</button>
        </div>
        
        <div id="about-container" class="fields-list">
          {aboutSections && aboutSections.length > 0 ? (
            aboutSections.map((section, index) => (
              <div class="dynamic-group">
                <div class="group-header">
                  <div class="order-controls">
                    <button type="button" class="order-btn up" onclick="moveRow(this, 'up')">▲</button>
                    <button type="button" class="order-btn down" onclick="moveRow(this, 'down')">▼</button>
                    <span class="index-label">SECTION_{String(index + 1).padStart(2, '0')}</span>
                    <select name="about_langs[]" class="lang-select">
                        <option value="en" selected={section.lang === 'en'}>ANGLAIS</option>
                        <option value="fr" selected={section.lang === 'fr'}>FRANÇAIS</option>
                    </select>
                  </div>
                  <button type="button" class="delete-btn" onclick="this.closest('.dynamic-group').remove(); refreshUI();">SUPPRIMER</button>
                </div>
                <div class="input-stack">
                  <input type="text" name="about_titles[]" value={section.title} placeholder="TITRE_STRING" spellcheck="false" />
                  <textarea name="about_contents[]" placeholder="CORPS_DU_CONTENU" spellcheck="false">{section.content}</textarea>
                </div>
              </div>
            ))
          ) : null}
        </div>

        <div class="action-bar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2.5rem; padding-bottom: 2rem; border-bottom: 1px solid #222;">
          <div class="status-box">
             {isPost && saveStatus && <span id="server-status" class={saveStatus.includes('SUCCESS') ? 'msg-ok' : 'msg-err'}>{saveStatus}</span>}
             <span id="client-error" class="msg-err" style="display: none;">ERREUR DE VALIDATION : CHAMPS VIDES DÉTECTÉS</span>
          </div>
          <button type="submit" class="submit-btn" 
            style="background: #edba3a; border: none; color: #000; padding: 12px 30px; font-weight: 900; font-family: monospace; cursor: pointer; transition: 0.2s;"
            onmouseover="this.style.background='#fff'" 
            onmouseout="this.style.background='#edba3a'">
            SOUMETTRE
          </button>
        </div>
      </section>

      <section class="config-block">
        <h2 class="block-title" style="margin-bottom: 2.5rem;">02 // SQB</h2>
        <div class="lock-overlay">AUCUN CHAMP DE DONNÉES DÉFINI. SYNC DB EN ATTENTE.</div>
      </section>

      <section class="config-block">
        <h2 class="block-title" style="margin-bottom: 2.5rem;">03 // AUTRES MÉDIAS</h2>
        <div class="lock-overlay">CANAL CHIFFRÉ - EN ATTENTE.</div>
      </section>

    </form>
  </div>
</Layout>

<script is:inline>
  const UI_STYLE = {
    group: "background: rgba(13, 14, 18, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(237, 186, 58, 0.1); border-left: 4px solid #edba3a; padding: 2rem; margin-bottom: 2rem; display: block;",
    header: "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;",
    controls: "display: flex; align-items: center; gap: 10px;",
    langSelect: "background: #000; border: 1px solid #edba3a; color: #edba3a; font-family: Simhei; font-size: 0.7rem; padding: 2px 5px; outline: none; cursor: pointer;",
    orderBtn: "background: transparent; border: 1px solid rgba(237, 186, 58, 0.4); color: #edba3a; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: 0.2s;",
    index: "color: #edba3a; font-family: monospace; font-size: 0.8rem; font-weight: bold; margin-left: 10px;",
    delete: "background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 6px 15px; font-family: monospace; font-size: 0.7rem; font-weight: bold; cursor: pointer; transition: 0.2s;",
    stack: "display: flex; flex-direction: column; gap: 15px;",
    input: "width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #edba3a; font-family: 'Courier New', monospace; font-size: 1.1rem; outline: none; transition: all 0.3s ease; caret-color: #edba3a; box-sizing: border-box;",
    textarea: "width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #aaa; font-family: inherit; line-height: 1.6; min-height: 120px; outline: none; transition: all 0.3s ease; caret-color: #edba3a; resize: vertical; box-sizing: border-box;"
  };

  const container = document.getElementById('about-container');
  const addBtn = document.getElementById('add-section');
  const mainForm = document.getElementById('main-form');
  const serverStatus = document.getElementById('server-status');

  if (serverStatus && serverStatus.innerText.includes('SUCCESS')) {
    window.location.href = window.location.pathname;
  }

  function bindInputEffects(parent) {
    parent.querySelectorAll('input, textarea').forEach(el => {
      el.onfocus = () => { el.style.borderColor = '#edba3a'; el.style.background = 'rgba(237, 186, 58, 0.05)'; };
      el.onblur = () => { el.style.borderColor = 'rgba(255, 255, 255, 0.1)'; el.style.background = 'rgba(255, 255, 255, 0.05)'; };
    });
  }

  addBtn.addEventListener('click', () => {
    const div = document.createElement('div');
    div.className = 'dynamic-group';
    div.setAttribute('style', UI_STYLE.group);
    div.innerHTML = `
      <div style="${UI_STYLE.header}">
        <div style="${UI_STYLE.controls}">
           <button type="button" class="order-btn up" onclick="moveRow(this, 'up')" style="${UI_STYLE.orderBtn}">▲</button>
           <button type="button" class="order-btn down" onclick="moveRow(this, 'down')" style="${UI_STYLE.orderBtn}">▼</button>
           <span class="index-label" style="${UI_STYLE.index}">NOUVELLE_SECTION</span>
           <select name="about_langs[]" class="lang-select" style="${UI_STYLE.langSelect}">
              <option value="en">ANGLAIS</option>
              <option value="fr">FRANÇAIS</option>
           </select>
        </div>
        <button type="button" class="js-del" style="${UI_STYLE.delete}">SUPPRIMER</button>
      </div>
      <div style="${UI_STYLE.stack}">
        <input type="text" name="about_titles[]" placeholder="TITRE_STRING" style="${UI_STYLE.input}" />
        <textarea name="about_contents[]" placeholder="CORPS_DU_CONTENU" style="${UI_STYLE.textarea}"></textarea>
      </div>
    `;
    bindInputEffects(div);
    div.querySelector('.js-del').onclick = () => { div.remove(); refreshUI(); };
    container.appendChild(div);
    refreshUI();
  });

  mainForm.addEventListener('submit', (e) => {
    let hasError = false;
    container.querySelectorAll('input, textarea').forEach(f => {
      if (!f.value.trim()) {
        f.style.borderColor = "#ff4444";
        f.style.background = "rgba(255, 68, 68, 0.05)";
        hasError = true;
      } else {
        f.style.borderColor = "rgba(255, 255, 255, 0.1)";
      }
    });
    if (hasError) {
      e.preventDefault();
      document.getElementById('client-error').style.display = "inline";
      setTimeout(() => { document.getElementById('client-error').style.display = "none"; }, 3000);
    }
  });

  window.moveRow = (btn, dir) => {
    const current = btn.closest('.dynamic-group');
    if (dir === 'up' && current.previousElementSibling) container.insertBefore(current, current.previousElementSibling);
    else if (dir === 'down' && current.nextElementSibling) container.insertBefore(current.nextElementSibling, current);
    refreshUI();
  };

  window.refreshUI = () => {
    const groups = container.querySelectorAll('.dynamic-group');
    groups.forEach((group, i) => {
      group.querySelector('.index-label').innerText = `SECTION_${String(i + 1).padStart(2, '0')}`;
      const up = group.querySelector('.up'), down = group.querySelector('.down');
      if(up) up.style.visibility = (i === 0) ? 'hidden' : 'visible';
      if(down) down.style.visibility = (i === groups.length - 1) ? 'hidden' : 'visible';
    });
  };

  bindInputEffects(document);
  refreshUI();
</script>

<style>
  .settings-wrapper { max-width: 900px; margin: 0 auto; padding: 2rem 1rem 12rem 1rem; color: #fff; }
  .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5rem; }
  .mode-indicator { color: #00ff00; font-family: monospace; font-size: 0.8rem; display: flex; align-items: center; gap: 10px; }
  .dot { width: 8px; height: 8px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 10px #00ff00; animation: blink 1.5s infinite; }
  .back-btn { color: #edba3a; text-decoration: none; font-family: monospace; font-size: 0.8rem; border: 1px solid #edba3a; padding: 8px 20px; transition: 0.2s; }
  .back-btn:hover { background: rgba(237, 186, 58, 0.1); }

  .config-block { margin-bottom: 8rem; position: relative; clear: both; }
  .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; border-bottom: 1px solid #222; padding-bottom: 15px; }
  .block-title { color: #edba3a; font-size: 1.5rem; font-weight: bold; margin: 0; letter-spacing: 2px; }

  .add-btn { background: #edba3a; border: none; color: #000; padding: 10px 25px; font-weight: 900; font-family: monospace; cursor: pointer; transition: 0.2s; }
  .add-btn:hover { background: #fff; }

  .dynamic-group { background: rgba(13, 14, 18, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(237, 186, 58, 0.1); border-left: 4px solid #edba3a; padding: 2rem; margin-bottom: 2rem; }
  .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
  .order-controls { display: flex; align-items: center; gap: 12px; }

  .lang-select { 
    background: #000 !important; color: #edba3a !important; border: 1px solid rgba(237, 186, 58, 0.5); 
    font-family: Simhei; font-size: 0.7rem; padding: 4px 8px; outline: none; cursor: pointer; transition: 0.2s;
  }
  .lang-select option { background: #000; color: #edba3a; }
  .lang-select:focus { border-color: #edba3a; background: rgba(237, 186, 58, 0.1) !important; }

  .order-btn { background: transparent; border: 1px solid rgba(237, 186, 58, 0.4); color: #edba3a; width: 30px; height: 30px; cursor: pointer; }
  .order-btn:hover { background: rgba(237, 186, 58, 0.2); }
  .delete-btn { background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 6px 15px; font-weight: bold; cursor: pointer; }
  .delete-btn:hover { background: rgba(255, 68, 68, 0.2); }

  input[type="text"], textarea { 
    width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); 
    color: #edba3a; font-family: 'Courier New', monospace; font-size: 1.1rem; outline: none; transition: 0.3s; caret-color: #edba3a; 
  }
  textarea { color: #aaa; min-height: 120px; resize: vertical; font-family: inherit; }
  input:focus, textarea:focus { border-color: #edba3a; background: rgba(237, 186, 58, 0.05); }

  .lock-overlay { border: 1px dashed #222; padding: 4rem; text-align: center; color: #333; font-family: monospace; font-size: 0.9rem; letter-spacing: 1px; }
  .msg-ok { color: #00ff00; font-family: monospace; }
  .msg-err { color: #ff4444; font-family: monospace; font-weight: bold; animation: blink 2s infinite; }

  @keyframes blink { 50% { opacity: 0.5; } }
</style>