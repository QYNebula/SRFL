---

export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';


// Backend Logic: Handle Login Validation
let errorMessage = "";
// Step 1: /login?discord=1 -> redirect to Supabase Discord OAuth
const discordFlag = Astro.url.searchParams.get('discord');

if (discordFlag === '1') {
  const SUPABASE_URL = import.meta.env.SUPABASE_URL;
  const SUPABASE_ANON_KEY = import.meta.env.SUPABASE_ANON_KEY;

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    errorMessage = "ERREUR SYSTÈME : SUPABASE ENV MANQUANTE";
  } else {
    const anon = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false, autoRefreshToken: false }
    });

    const redirectTo = `${Astro.url.origin}/login`; // 回跳仍回 login，下一步再处理 code
    const { data, error } = await anon.auth.signInWithOAuth({
      provider: 'discord',
      options: { redirectTo }
    });

    if (error || !data?.url) {
      errorMessage = "ERREUR SYSTÈME : ÉCHEC OAUTH DISCORD";
    } else {
      return Astro.redirect(data.url);
    }
  }
}

---

<Layout title="TERMINAL ACCESS | SRFL">
  <div class="login-wrapper">
    <div class="login-card">
      <h1 class="title">TERMINAL D'ADMINISTRATION</h1>
      {errorMessage && <p class="error">{errorMessage}</p>}
      <form method="GET" style="margin-top: 0;">
        <input type="hidden" name="discord" value="1" />
        <button type="submit">CONNEXION VIA DISCORD</button>
      </form>
      <div class="security-note">
        CANAL CHIFFRÉ - RÉSERVÉ AU PERSONNEL AUTORISÉ
      </br>ENCRYPTED CHANNEL - AUTHORIZED PERSONNEL ONLY
      </div>
    </div>
  </div>
</Layout>


<style>
    /* 针对登录页所有元素的暴力清空：强制隐藏系统光标 */
    .login-wrapper, 
    .login-wrapper *, 
    .login-card, 
    .login-card * {
        cursor: none !important;
    }

    /* 允许文本可以被选中，但光标依然不可见 */
    .title, label, .security-note, p {
        cursor: none !important;
    }
    input, button {
        cursor: none !important;
    }
    .login-wrapper {
        height: 80vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-top: 70px;
    }

    .login-card {
        background: rgba(13, 14, 18, 0.9);
        backdrop-filter: blur(15px);
        padding: 3rem;
        border: 1px solid rgba(237, 186, 58, 0.3);
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        text-align: center;
    }

    .title {
        color: #edba3a; /* Your Theme Gold */
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: 4px;
        margin-bottom: 2.5rem;
        text-transform: uppercase;
    }

    .input-box {
        text-align: left;
        margin-bottom: 2rem;
    }

    .input-box label {
        display: block;
        color: #666;
        font-size: 0.7rem;
        letter-spacing: 2px;
        margin-bottom: 10px;
    }

    .input-box input {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #edba3a;
        font-family: 'Courier New', monospace;
        font-size: 1.1rem;
        outline: none;
        transition: all 0.3s ease;
        caret-color: #edba3a;
    }

    .input-box input:focus {
        border-color: #edba3a;
        background: rgba(237, 186, 58, 0.05);
    }

    button {
        width: 100%;
        padding: 15px;
        background: #edba3a;
        border: none;
        color: #000;
        font-weight: 900;
        font-size: 0.9rem;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }

    button:hover {
        background: #fff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(237, 186, 58, 0.3);
    }

    .error {
        color: #ff4444;
        font-size: 0.8rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        letter-spacing: 1px;
        animation: blink 2s infinite;
    }

    .security-note {
        margin-top: 2rem;
        font-size: 0.8rem;
        color: #444;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    @keyframes blink {
        50% { opacity: 0.5; }
    }
</style>

<script is:inline>
  (async function () {
    console.log('[discord cb] script running, hash =', window.location.hash);
    // 只处理 Discord 回跳：hash 里带 access_token
    const hash = window.location.hash || '';
    if (!hash.includes('access_token=')) return;

    const params = new URLSearchParams(hash.slice(1));
    const access_token = params.get('access_token');
    console.log(
    '[discord cb] access_token?',
    !!access_token,
    access_token ? access_token.slice(0, 12) + '...' : null
    );

    if (!access_token) return;

    // 发给后端验证 + set cookie
    const res = await fetch('/api/discord-verify', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${access_token}`, 
      },
      body: JSON.stringify({ access_token })
    });

    if (res.ok) {
      // 清理 hash（可选，但推荐，避免刷新重复跑）
      history.replaceState(null, '', '/login');
      window.location.href = '/admin/dashboard';
    } else {
      // 如果失败，你不想改 UI，我们先让它保持在登录页；你可以打开控制台看原因
      const msg = await res.text().catch(() => '');
      console.error('discord verify failed:', res.status, msg);
      history.replaceState(null, '', '/login');
    }
  })();
</script>
